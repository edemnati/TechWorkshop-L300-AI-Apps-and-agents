name: Run Customer Loyalty Agent

on:
  push:
    paths:
      - 'src/app/agents/customerLoyaltyAgent_initializer.py'
      - 'src/app/tools/discountLogic.py'
      - 'src/prompts/CustomerLoyaltyAgentPrompt.txt'
  pull_request:
    paths:
      - 'src/app/agents/customerLoyaltyAgent_initializer.py'
      - 'src/app/tools/discountLogic.py'
      - 'src/prompts/CustomerLoyaltyAgentPrompt.txt'

jobs:
  run-agent:
    name: Execute customerLoyaltyAgent_initializer.py
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.x
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('src/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies from src/requirements.txt
        run: |
          python -m pip install --upgrade pip
          pip install -r src/requirements.txt

      - name: Export ENV secret variables to environment
        if: ${{ secrets.ENV != '' }}
        run: |
          # secrets.ENV is expected to be lines of KEY=VALUE (or similar). We write it to a temp file
          # and append valid KEY=VALUE lines to $GITHUB_ENV so they become available to later steps.
          printf "%s\n" "${{ secrets.ENV }}" > .env || true
          while IFS= read -r line; do
            # skip empty lines and comment lines
            if [ -n "$line" ] && [ "${line#\#}" = "$line" ]; then
              echo "$line" >> "$GITHUB_ENV"
            fi
          done < .env

      - name: Parse AZURE_CREDENTIALS and export standard AZURE_* env vars
        if: ${{ secrets.AZURE_CREDENTIALS != '' }}
        run: |
          # Write the raw JSON from the secret to a file
          printf "%s\n" "${{ secrets.AZURE_CREDENTIALS }}" > azure_creds.json
          # Use Python to parse the JSON and append common AZURE_* variables to GITHUB_ENV so
          # azure.identity.DefaultAzureCredential (or explicit credentials) can pick them up.
          python - <<'PY'
import json, os
creds = json.load(open('azure_creds.json'))
mapping = {
  'clientId': 'AZURE_CLIENT_ID',
  'tenantId': 'AZURE_TENANT_ID',
  'clientSecret': 'AZURE_CLIENT_SECRET',
  'subscriptionId': 'AZURE_SUBSCRIPTION_ID'
}
with open(os.environ['GITHUB_ENV'], 'a') as gh:
    for k, env_name in mapping.items():
        if k in creds and creds[k] is not None:
            gh.write(f"{env_name}={creds[k]}\n")
PY

      - name: Azure Login (optional, helps set session for az CLI and some SDK operations)
        if: ${{ secrets.AZURE_CREDENTIALS != '' }}
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Run the Customer Loyalty Agent initializer
        env:
          # Any variables exported to GITHUB_ENV are available here automatically.
          # Add any explicit env overrides here if needed.
        run: |
          python src/app/agents/customerLoyaltyAgent_initializer.py
