name: Run Customer Loyalty Agent

on:
  push:
    paths:
      - 'src/app/agents/customerLoyaltyAgent_initializer.py'
      - 'src/app/tools/discountLogic.py'
      - 'src/prompts/CustomerLoyaltyAgentPrompt.txt'
  pull_request:
    paths:
      - 'src/app/agents/customerLoyaltyAgent_initializer.py'
      - 'src/app/tools/discountLogic.py'
      - 'src/prompts/CustomerLoyaltyAgentPrompt.txt'

jobs:
  run-agent:
    name: Execute customerLoyaltyAgent_initializer.py
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('src/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies from src/requirements.txt
        run: |
          python -m pip install --upgrade pip
          pip install -r src/requirements.txt

      - name: Load ENV secret into environment (expects KEY=VALUE lines)
        env:
          SECRET_ENV: ${{ secrets.ENV }}
        run: |
          if [ -n "$SECRET_ENV" ]; then
            printf "%s\n" "$SECRET_ENV" > .env || true
            while IFS= read -r line; do
              # skip empty lines and comment lines
              if [ -n "$line" ] && [ "${line#\#}" = "$line" ]; then
                echo "$line" >> "$GITHUB_ENV"
              fi
            done < .env
            echo "ENV secret loaded to GITHUB_ENV"
          else
            echo "No ENV secret provided; skipping"
          fi

      - name: Parse AZURE_CREDENTIALS and export AZURE_* env vars
        env:
          AZ_CREDS: ${{ secrets.AZURE_CREDENTIALS }}
        run: |
          if [ -n "$AZ_CREDS" ]; then
            # write secret JSON to file so Python can safely parse it
            printf '%s' "$AZ_CREDS" > azure_creds.json
            # parse JSON and append common AZURE_* variables to GITHUB_ENV
            python - <<'PY'
import json, os, sys
try:
    creds = json.load(open('azure_creds.json'))
except Exception:
    sys.exit(0)
mapping = {
    'clientId': 'AZURE_CLIENT_ID',
    'tenantId': 'AZURE_TENANT_ID',
    'clientSecret': 'AZURE_CLIENT_SECRET',
    'subscriptionId': 'AZURE_SUBSCRIPTION_ID'
}
gh_env = os.environ.get('GITHUB_ENV')
if not gh_env:
    sys.exit(0)
with open(gh_env, 'a') as gh:
    for k, env_name in mapping.items():
        val = creds.get(k)
        if val:
            gh.write(f"{env_name}={val}\n")
PY
            echo "AZURE_CREDENTIALS parsed into AZURE_* env vars"
          else
            echo "No AZURE_CREDENTIALS secret provided; skipping"
          fi

      - name: Azure Login (optional, provides az CLI/session)
        if: ${{ secrets.AZURE_CREDENTIALS != '' }}
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Run the Customer Loyalty Agent initializer
        env:
          # ensure package imports under src/ work correctly
          PYTHONPATH: src
        run: |
          python src/app/agents/customerLoyaltyAgent_initializer.py
