name: Run Customer Loyalty Agent

on:
  push:
    paths:
      - 'src/app/agents/customerLoyaltyAgent_initializer.py'
      - 'src/app/tools/discountLogic.py'
      - 'src/prompts/CustomerLoyaltyAgentPrompt.txt'
  pull_request:
    paths:
      - 'src/app/agents/customerLoyaltyAgent_initializer.py'
      - 'src/app/tools/discountLogic.py'
      - 'src/prompts/CustomerLoyaltyAgentPrompt.txt'

jobs:
  run-agent:
    name: Execute customerLoyaltyAgent_initializer.py
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.x
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('src/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies from src/requirements.txt
        run: |
          python -m pip install --upgrade pip
          pip install -r src/requirements.txt

      - name: Export ENV secret variables to environment
        env:
          SECRET_ENV: ${{ secrets.ENV }}
        run: |
          if [ -n "$SECRET_ENV" ]; then
            printf "%s\n" "$SECRET_ENV" > .env
            while IFS= read -r line; do
              # skip empty lines and comment lines
              if [ -n "$line" ] && [ "${line#\#}" = "$line" ]; then
                echo "$line" >> "$GITHUB_ENV"
              fi
            done < .env
            echo "Loaded ENV secret into environment."
          else
            echo "No ENV secret provided; skipping."
          fi

      - name: Parse AZURE_CREDENTIALS and export AZURE_* env vars
        env:
          AZ_CREDS: ${{ secrets.AZURE_CREDENTIALS }}
        run: |
          if [ -n "$AZ_CREDS" ]; then
            echo "$AZ_CREDS" > azure_creds.json
            # Try using jq to parse; fallback to Python if jq isn't available.
            if command -v jq >/dev/null 2>&1; then
              CLIENT_ID=$(jq -r '.clientId // empty' azure_creds.json)
              TENANT_ID=$(jq -r '.tenantId // empty' azure_creds.json)
              CLIENT_SECRET=$(jq -r '.clientSecret // empty' azure_creds.json)
              SUBSCRIPTION_ID=$(jq -r '.subscriptionId // empty' azure_creds.json)
              [ -n "$CLIENT_ID" ] && echo "AZURE_CLIENT_ID=$CLIENT_ID" >> "$GITHUB_ENV"
              [ -n "$TENANT_ID" ] && echo "AZURE_TENANT_ID=$TENANT_ID" >> "$GITHUB_ENV"
              [ -n "$CLIENT_SECRET" ] && echo "AZURE_CLIENT_SECRET=$CLIENT_SECRET" >> "$GITHUB_ENV"
              [ -n "$SUBSCRIPTION_ID" ] && echo "AZURE_SUBSCRIPTION_ID=$SUBSCRIPTION_ID" >> "$GITHUB_ENV"
            else
              python - <<'PY'
import json, os
creds = json.load(open('azure_creds.json'))
mapping = {
  'clientId': 'AZURE_CLIENT_ID',
  'tenantId': 'AZURE_TENANT_ID',
  'clientSecret': 'AZURE_CLIENT_SECRET',
  'subscriptionId': 'AZURE_SUBSCRIPTION_ID'
}
with open(os.environ['GITHUB_ENV'], 'a') as gh:
    for k, env_name in mapping.items():
        val = creds.get(k)
        if val:
            gh.write(f"{env_name}={val}\n")
PY
            fi
            echo "Parsed AZURE_CREDENTIALS into AZURE_* environment variables."
          else
            echo "No AZURE_CREDENTIALS secret provided; skipping."
          fi

      - name: Azure Login (optional, provides az CLI/session)
        if: ${{ secrets.AZURE_CREDENTIALS != '' }}
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Run the Customer Loyalty Agent initializer
        run: |
          python src/app/agents/customerLoyaltyAgent_initializer.py
